## å‰è¨€
è‡ªä»[micro-app](https://github.com/micro-zoe/micro-app)å¼€æºåï¼Œå¾ˆå¤šå°ä¼™ä¼´éƒ½éå¸¸æ„Ÿå…´è¶£ï¼Œé—®æˆ‘å…·ä½“çš„å®ç°æ–¹å¼ï¼Œå…¶å®å¾®å‰ç«¯çš„å®ç°æ–¹å¼å¤§åŒå°å¼‚ï¼ŒåŸºæœ¬æ ¸å¿ƒåœ¨äºåŠ è½½æ¸²æŸ“ã€‚æˆ‘ä¼šé€šè¿‡ä¸€ä¸ªç³»åˆ—æ–‡ç« ï¼Œä»‹ç»å¾®å‰ç«¯çš„åŸºæœ¬åŸç†åŠæ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼šåŠ è½½æ¸²æŸ“ã€JSæ²™ç®±ã€CSSéš”ç¦»ã€æ•°æ®é€šä¿¡ï¼Œå¹¶å®ç°ä¸€ä¸ªç®€æ˜“çš„å¾®å‰ç«¯æ¡†æ¶ã€‚

é€šè¿‡è¿™äº›æ–‡ç« ï¼Œä½ å¯ä»¥äº†è§£å¾®å‰ç«¯æ¡†æ¶çš„å…·ä½“åŸç†å’Œå®ç°æ–¹å¼ï¼Œè¿™åœ¨ä½ ä»¥åä½¿ç”¨å¾®å‰ç«¯æˆ–è€…è‡ªå·±å†™ä¸€å¥—å¾®å‰ç«¯æ¡†æ¶æ—¶ä¼šæœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµç•™è¨€ã€‚

## ç›¸å…³æ¨è
micro-appæºç åœ°å€ï¼šhttps://github.com/micro-zoe/micro-app

## æ•´ä½“æ¶æ„
å’Œmicro-appä¸€æ ·ï¼Œæˆ‘ä»¬çš„ç®€æ˜“å¾®å‰ç«¯æ¡†æ¶è®¾è®¡æ€è·¯æ˜¯åƒä½¿ç”¨iframeä¸€æ ·ç®€å•ï¼Œè€Œåˆå¯ä»¥é¿å…iframeå­˜åœ¨çš„é—®é¢˜ï¼Œå…¶ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

![](https://img13.360buyimg.com/imagetools/jfs/t1/181724/1/15979/23894/60ffedfcEa74486b6/9cfeb02f4347357a.png)

æœ€ç»ˆæ•ˆæœä¹Ÿæœ‰ç‚¹ç±»ä¼¼ï¼Œæ•´ä¸ªå¾®å‰ç«¯åº”ç”¨éƒ½è¢«å°è£…åœ¨è‡ªå®šä¹‰æ ‡ç­¾micro-appä¸­ï¼Œæ¸²æŸ“åæ•ˆæœå¦‚ä¸‹å›¾ï¼š

![](https://img11.360buyimg.com/imagetools/jfs/t1/187866/25/15336/129323/60ffc089E76d6416d/9fb1f6ee70499254.png)

æ‰€ä»¥æˆ‘ä»¬æ•´ä½“æ¶æ„æ€è·¯ä¸ºï¼š**CustomElement + HTMLEntry**ã€‚

HTMLEntryå°±æ˜¯ä»¥htmlæ–‡ä»¶ä½œä¸ºå…¥å£åœ°å€è¿›è¡Œæ¸²æŸ“ï¼Œå…¥ä¸Šå›¾ä¸­çš„`http://localhost:3000/`å°±æ˜¯ä¸€ä¸ªhtmlåœ°å€ã€‚

**æ¦‚å¿µå›¾ï¼š**
![](https://img10.360buyimg.com/imagetools/jfs/t1/188133/39/15743/117766/61024cd2E5ed84b36/b816384088ba6ed1.png)

## å‰ç½®å·¥ä½œ
åœ¨æ­£å¼å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ­å»ºä¸€ä¸ªå¼€å‘ç¯å¢ƒï¼Œåˆ›å»ºä¸€ä¸ªä»£ç ä»“åº“`simple-micro-app`ã€‚

**ç›®å½•ç»“æ„**
![](https://img11.360buyimg.com/imagetools/jfs/t1/196336/1/15327/76954/6102650dE1f9d7850/3fe44809e029d4d5.png)


ä»£ç ä»“åº“ä¸»è¦åˆ†ä¸ºsrcä¸»ç›®å½•å’Œexamplesæ¡ˆä¾‹ç›®å½•ï¼Œvue2ä¸ºåŸºåº§åº”ç”¨ï¼Œreact17ä¸ºå­åº”ç”¨ï¼Œä¸¤ä¸ªé¡¹ç›®éƒ½æ˜¯ä½¿ç”¨å®˜æ–¹è„šæ‰‹æ¶åˆ›å»ºçš„ï¼Œæ„å»ºå·¥å…·ä½¿ç”¨rollupã€‚

ä¸¤ä¸ªåº”ç”¨é¡µé¢åˆ†åˆ«å¦‚ä¸‹å›¾ï¼š

**åŸºåº§åº”ç”¨ -- vue2**
![](https://img14.360buyimg.com/imagetools/jfs/t1/183486/38/17307/81178/6107bfb4E651ac3f8/37cfca6b3ca62cc1.png)

**å­åº”ç”¨ -- react17**
![](https://img12.360buyimg.com/imagetools/jfs/t1/183475/14/17257/107373/6107bfbaEdf0e0509/75b199e0e408040e.png)


åœ¨vue2é¡¹ç›®ä¸­ï¼Œé…ç½®`resolve.alias`ï¼Œå°†simple-micro-appæŒ‡å‘srcç›®å½•çš„index.jsã€‚
```js
// vue.config.js
...
chainWebpack: config => {
    config.resolve.alias
      .set("simple-micro-app", path.join(__dirname, '../../src/index.js'))
  },
```
åœ¨react17çš„webpack-dev-serverä¸­é…ç½®é™æ€èµ„æºæ”¯æŒè·¨åŸŸè®¿é—®ã€‚
```js
// config/webpackDevServer.config.js
...
headers: {
  'Access-Control-Allow-Origin': '*',
},
```

## æ­£å¼å¼€å§‹
ä¸ºäº†è®²çš„æ›´åŠ æ˜ç™½ï¼Œæˆ‘ä»¬ä¸ä¼šç›´æ¥è´´å‡ºå·²ç»å®Œæˆçš„ä»£ç ï¼Œè€Œæ˜¯ä»æ— åˆ°æœ‰ï¼Œä¸€æ­¥æ­¥å®ç°æ•´ä¸ªè¿‡ç¨‹ï¼Œè¿™æ ·æ‰èƒ½æ›´åŠ æ¸…æ™°ï¼Œå®¹æ˜“ç†è§£ã€‚

### åˆ›å»ºå®¹å™¨
å¾®å‰ç«¯çš„æ¸²æŸ“æ˜¯å°†å­åº”ç”¨çš„jsã€cssç­‰é™æ€èµ„æºåŠ è½½åˆ°åŸºåº§åº”ç”¨ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥åŸºåº§åº”ç”¨å’Œå­åº”ç”¨æœ¬è´¨æ˜¯åŒä¸€ä¸ªé¡µé¢ã€‚è¿™ä¸åŒäºiframeï¼Œiframeåˆ™æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£ï¼Œç”±äºæ¯æ¬¡åŠ è½½éƒ½è¦åˆå§‹åŒ–æ•´ä¸ªçª—å£ä¿¡æ¯ï¼Œæ‰€ä»¥iframeçš„æ€§èƒ½ä¸é«˜ã€‚

å¦‚åŒæ¯ä¸ªå‰ç«¯æ¡†æ¶åœ¨æ¸²æŸ“æ—¶éƒ½è¦æŒ‡å®šä¸€ä¸ªæ ¹å…ƒç´ ï¼Œå¾®å‰ç«¯æ¸²æŸ“æ—¶ä¹Ÿéœ€è¦æŒ‡å®šä¸€ä¸ªæ ¹å…ƒç´ ä½œä¸ºå®¹å™¨ï¼Œè¿™ä¸ªæ ¹å…ƒç´ å¯ä»¥æ˜¯ä¸€ä¸ªdivæˆ–å…¶å®ƒå…ƒç´ ã€‚

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é€šè¿‡customElementsåˆ›å»ºçš„è‡ªå®šä¹‰å…ƒç´ ï¼Œå› ä¸ºå®ƒä¸ä»…æä¾›ä¸€ä¸ªå…ƒç´ å®¹å™¨ï¼Œè¿˜è‡ªå¸¦äº†ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™äº›é’©å­å‡½æ•°ä¸­è¿›è¡ŒåŠ è½½æ¸²æŸ“ç­‰æ“ä½œï¼Œä»è€Œç®€åŒ–æ­¥éª¤ã€‚

```js
// /src/element.js

// è‡ªå®šä¹‰å…ƒç´ 
class MyElement extends HTMLElement {
  // å£°æ˜éœ€è¦ç›‘å¬çš„å±æ€§åï¼Œåªæœ‰è¿™äº›å±æ€§å˜åŒ–æ—¶æ‰ä¼šè§¦å‘attributeChangedCallback
  static get observedAttributes () {
    return ['name', 'url']
  }

  constructor() {
    super();
  }

  connectedCallback() {
    // å…ƒç´ è¢«æ’å…¥åˆ°DOMæ—¶æ‰§è¡Œï¼Œæ­¤æ—¶å»åŠ è½½å­åº”ç”¨çš„é™æ€èµ„æºå¹¶æ¸²æŸ“
    console.log('micro-app is connected')
  }

  disconnectedCallback () {
    // å…ƒç´ ä»DOMä¸­åˆ é™¤æ—¶æ‰§è¡Œï¼Œæ­¤æ—¶è¿›è¡Œä¸€äº›å¸è½½æ“ä½œ
    console.log('micro-app has disconnected')
  }

  attributeChangedCallback (attr, oldVal, newVal) {
    // å…ƒç´ å±æ€§å‘ç”Ÿå˜åŒ–æ—¶æ‰§è¡Œï¼Œå¯ä»¥è·å–nameã€urlç­‰å±æ€§çš„å€¼
    console.log(`attribute ${attrName}: ${newVal}`)
  }
}

/**
 * æ³¨å†Œå…ƒç´ 
 * æ³¨å†Œåï¼Œå°±å¯ä»¥åƒæ™®é€šå…ƒç´ ä¸€æ ·ä½¿ç”¨micro-appï¼Œå½“micro-appå…ƒç´ è¢«æ’å…¥æˆ–åˆ é™¤DOMæ—¶å³å¯è§¦å‘ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚
 */
window.customElements.define('micro-app', MyElement)
```

`micro-app`å…ƒç´ å¯èƒ½å­˜åœ¨é‡å¤å®šä¹‰çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ ä¸€å±‚åˆ¤æ–­ï¼Œå¹¶æ”¾å…¥å‡½æ•°ä¸­ã€‚
```js
// /src/element.js

export function defineElement () {
  // å¦‚æœå·²ç»å®šä¹‰è¿‡ï¼Œåˆ™å¿½ç•¥
  if (!window.customElements.get('micro-app')) {
    window.customElements.define('micro-app', MyElement)
  }
}
```

åœ¨`/src/index.js`ä¸­å®šä¹‰é»˜è®¤å¯¹è±¡`SimpleMicroApp`ï¼Œå¼•å…¥å¹¶æ‰§è¡Œ`defineElement`å‡½æ•°ã€‚
```js
// /src/index.js

import { defineElement } from './element'

const SimpleMicroApp = {
  start () {
    defineElement()
  }
}

export default SimpleMicroApp
```

**å¼•å…¥simple-micro-app**
åœ¨vue2é¡¹ç›®çš„main.jsä¸­å¼•å…¥simple-micro-appï¼Œæ‰§è¡Œstartå‡½æ•°è¿›è¡Œåˆå§‹åŒ–ã€‚
```js
// vue2/src/main.js

import SimpleMicroApp from 'simple-micro-app'

SimpleMicroApp.start()
```

ç„¶åå°±å¯ä»¥åœ¨vue2é¡¹ç›®ä¸­çš„ä»»ä½•ä½ç½®ä½¿ç”¨micro-appæ ‡ç­¾ã€‚
```html
<!-- page1.vue -->
<template>
  <div>
    <micro-app name='app' url='http://localhost:3001/'></micro-app>
  </div>
</template>
```
æ’å…¥micro-appæ ‡ç­¾åï¼Œå°±å¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°çš„é’©å­ä¿¡æ¯ã€‚
![](https://img14.360buyimg.com/imagetools/jfs/t1/185099/11/16261/81332/610297a1Ede21e543/999043868783cbec.png)

ä»¥ä¸Šæˆ‘ä»¬å°±å®Œæˆäº†å®¹å™¨å…ƒç´ çš„åˆå§‹åŒ–ï¼Œå­åº”ç”¨çš„æ‰€æœ‰å…ƒç´ éƒ½ä¼šæ”¾å…¥åˆ°è¿™ä¸ªå®¹å™¨ä¸­ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦å®Œæˆå­åº”ç”¨çš„é™æ€èµ„æºåŠ è½½åŠæ¸²æŸ“ã€‚

### åˆ›å»ºå¾®åº”ç”¨å®ä¾‹
å¾ˆæ˜¾ç„¶ï¼Œåˆå§‹åŒ–çš„æ“ä½œè¦æ”¾åœ¨`connectedCallback` ä¸­æ‰§è¡Œã€‚æˆ‘ä»¬å£°æ˜ä¸€ä¸ªç±»ï¼Œå®ƒçš„æ¯ä¸€ä¸ªå®ä¾‹éƒ½å¯¹åº”ä¸€ä¸ªå¾®åº”ç”¨ï¼Œç”¨äºæ§åˆ¶å¾®åº”ç”¨çš„èµ„æºåŠ è½½ã€æ¸²æŸ“ã€å¸è½½ç­‰ã€‚
```js
// /src/app.js

// åˆ›å»ºå¾®åº”ç”¨
export default class CreateApp {
  constructor () {}

  status = 'created' // ç»„ä»¶çŠ¶æ€ï¼ŒåŒ…æ‹¬ created/loading/mount/unmount

  // å­˜æ”¾åº”ç”¨çš„é™æ€èµ„æº
  source = { 
    links: new Map(), // linkå…ƒç´ å¯¹åº”çš„é™æ€èµ„æº
    scripts: new Map(), // scriptå…ƒç´ å¯¹åº”çš„é™æ€èµ„æº
  }

  // èµ„æºåŠ è½½å®Œæ—¶æ‰§è¡Œ
  onLoad () {}

  /**
   * èµ„æºåŠ è½½å®Œæˆåè¿›è¡Œæ¸²æŸ“
   */
  mount () {}

  /**
   * å¸è½½åº”ç”¨
   * æ‰§è¡Œå…³é—­æ²™ç®±ï¼Œæ¸…ç©ºç¼“å­˜ç­‰æ“ä½œ
   */
  unmount () {}
}
```

æˆ‘ä»¬åœ¨`connectedCallback`å‡½æ•°ä¸­åˆå§‹åŒ–å®ä¾‹ï¼Œå°†nameã€urlåŠå…ƒç´ è‡ªèº«ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œåœ¨`CreateApp`çš„constructorä¸­è®°å½•è¿™äº›å€¼ï¼Œå¹¶æ ¹æ®urlåœ°å€è¯·æ±‚htmlã€‚
```js
// /src/element.js
import CreateApp, { appInstanceMap } from './app'

...
connectedCallback () {
  // åˆ›å»ºå¾®åº”ç”¨å®ä¾‹
  const app = new CreateApp({
    name: this.name,
    url: this.url,
    container: this,
  })

  // è®°å…¥ç¼“å­˜ï¼Œç”¨äºåç»­åŠŸèƒ½
  appInstanceMap.set(this.name, app)
}

attributeChangedCallback (attrName, oldVal, newVal) {
  // åˆ†åˆ«è®°å½•nameåŠurlçš„å€¼
  if (attrName === 'name' && !this.name && newVal) {
    this.name = newVal
  } else if (attrName === 'url' && !this.url && newVal) {
    this.url = newVal
  }
}
...
```

åœ¨åˆå§‹åŒ–å®ä¾‹æ—¶ï¼Œæ ¹æ®ä¼ å…¥çš„å‚æ•°è¯·æ±‚é™æ€èµ„æºã€‚
```js
// /src/app.js
import loadHtml from './source'

// åˆ›å»ºå¾®åº”ç”¨
export default class CreateApp {
  constructor ({ name, url, container }) {
    this.name = name // åº”ç”¨åç§°
    this.url = url  // urlåœ°å€
    this.container = container // micro-appå…ƒç´ 
    this.status = 'loading'
    loadHtml(this)
  }
  ...
}
```

### è¯·æ±‚html
æˆ‘ä»¬ä½¿ç”¨fetchè¯·æ±‚é™æ€èµ„æºï¼Œå¥½å¤„æ˜¯æµè§ˆå™¨è‡ªå¸¦ä¸”æ”¯æŒpromiseï¼Œä½†è¿™ä¹Ÿè¦æ±‚å­åº”ç”¨çš„é™æ€èµ„æºæ”¯æŒè·¨åŸŸè®¿é—®ã€‚
```js
// src/source.js

export default function loadHtml (app) {
  fetch(app.url).then((res) => {
    return res.text()
  }).then((html) => {
    console.log('html:', html)
  }).catch((e) => {
    console.error('åŠ è½½htmlå‡ºé”™', e)
  })
}
```

å› ä¸ºè¯·æ±‚jsã€cssç­‰éƒ½éœ€è¦ä½¿ç”¨åˆ°fetchï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒæå–å‡ºæ¥ä½œä¸ºå…¬å…±æ–¹æ³•ã€‚
```js
// /src/utils.js

/**
 * è·å–é™æ€èµ„æº
 * @param {string} url é™æ€èµ„æºåœ°å€
 */
export function fetchSource (url) {
  return fetch(url).then((res) => {
    return res.text()
  })
}

```
é‡æ–°ä½¿ç”¨å°è£…åçš„æ–¹æ³•ï¼Œå¹¶å¯¹è·å–åˆ°åˆ°htmlè¿›è¡Œå¤„ç†ã€‚
```js
// src/source.js
import { fetchSource } from './utils'

export default function loadHtml (app) {
  fetchSource(app.url).then((html) => {
    html = html
      .replace(/<head[^>]*>[\s\S]*?<\/head>/i, (match) => {
        // å°†headæ ‡ç­¾æ›¿æ¢ä¸ºmicro-app-headï¼Œå› ä¸ºwebé¡µé¢åªå…è®¸æœ‰ä¸€ä¸ªheadæ ‡ç­¾
        return match
          .replace(/<head/i, '<micro-app-head')
          .replace(/<\/head>/i, '</micro-app-head>')
      })
      .replace(/<body[^>]*>[\s\S]*?<\/body>/i, (match) => {
        // å°†bodyæ ‡ç­¾æ›¿æ¢ä¸ºmicro-app-bodyï¼Œé˜²æ­¢ä¸åŸºåº§åº”ç”¨çš„bodyæ ‡ç­¾é‡å¤å¯¼è‡´çš„é—®é¢˜ã€‚
        return match
          .replace(/<body/i, '<micro-app-body')
          .replace(/<\/body>/i, '</micro-app-body>')
      })

    // å°†htmlå­—ç¬¦ä¸²è½¬åŒ–ä¸ºDOMç»“æ„
    const htmlDom = document.createElement('div')
    htmlDom.innerHTML = html
    console.log('html:', htmlDom)

    // è¿›ä¸€æ­¥æå–å’Œå¤„ç†jsã€cssç­‰é™æ€èµ„æº
    extractSourceDom(htmlDom, app)
  }).catch((e) => {
    console.error('åŠ è½½htmlå‡ºé”™', e)
  })
}
```
htmlæ ¼å¼åŒ–åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªDOMç»“æ„ã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªDOMç»“æ„åŒ…å«linkã€styleã€scriptç­‰æ ‡ç­¾ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦å¯¹è¿™ä¸ªDOMåšè¿›ä¸€æ­¥å¤„ç†ã€‚
![](https://img10.360buyimg.com/imagetools/jfs/t1/191546/8/15866/369938/6103a5c8E777fffb0/ca845992645ebea4.png)

### æå–jsã€cssç­‰é™æ€èµ„æºåœ°å€
æˆ‘ä»¬åœ¨`extractSourceDom`æ–¹æ³•ä¸­å¾ªç¯é€’å½’å¤„ç†æ¯ä¸€ä¸ªDOMèŠ‚ç‚¹ï¼ŒæŸ¥è¯¢åˆ°æ‰€æœ‰linkã€styleã€scriptæ ‡ç­¾ï¼Œæå–é™æ€èµ„æºåœ°å€å¹¶æ ¼å¼åŒ–æ ‡ç­¾ã€‚
```js
// src/source.js

/**
 * é€’å½’å¤„ç†æ¯ä¸€ä¸ªå­å…ƒç´ 
 * @param parent çˆ¶å…ƒç´ 
 * @param app åº”ç”¨å®ä¾‹
 */
function extractSourceDom(parent, app) {
  const children = Array.from(parent.children)
  
  // é€’å½’æ¯ä¸€ä¸ªå­å…ƒç´ 
  children.length && children.forEach((child) => {
    extractSourceDom(child, app)
  })

  for (const dom of children) {
    if (dom instanceof HTMLLinkElement) {
      // æå–cssåœ°å€
      const href = dom.getAttribute('href')
      if (dom.getAttribute('rel') === 'stylesheet' && href) {
        // è®¡å…¥sourceç¼“å­˜ä¸­
        app.source.links.set(href, {
          code: '', // ä»£ç å†…å®¹
        })
      }
      // åˆ é™¤åŸæœ‰å…ƒç´ 
      parent.removeChild(dom)
    } else if (dom instanceof HTMLScriptElement) {
      // å¹¶æå–jsåœ°å€
      const src = dom.getAttribute('src')
      if (src) { // è¿œç¨‹script
        app.source.scripts.set(src, {
          code: '', // ä»£ç å†…å®¹
          isExternal: true, // æ˜¯å¦è¿œç¨‹script
        })
      } else if (dom.textContent) { // å†…è”script
        const nonceStr = Math.random().toString(36).substr(2, 15)
        app.source.scripts.set(nonceStr, {
          code: dom.textContent, // ä»£ç å†…å®¹
          isExternal: false, // æ˜¯å¦è¿œç¨‹script
        })
      }

      parent.removeChild(dom)
    } else if (dom instanceof HTMLStyleElement) {
      // è¿›è¡Œæ ·å¼éš”ç¦»
    }
  }
}
```

### è¯·æ±‚é™æ€èµ„æº
ä¸Šé¢å·²ç»æ‹¿åˆ°äº†htmlä¸­çš„cssã€jsç­‰é™æ€èµ„æºçš„åœ°å€ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¯·æ±‚è¿™äº›åœ°å€ï¼Œæ‹¿åˆ°èµ„æºçš„å†…å®¹ã€‚

æ¥ç€å®Œå–„`loadHtml`ï¼Œåœ¨`extractSourceDom`ä¸‹é¢æ·»åŠ è¯·æ±‚èµ„æºçš„æ–¹æ³•ã€‚
```js
// src/source.js
...
export default function loadHtml (app) {
  ...
  // è¿›ä¸€æ­¥æå–å’Œå¤„ç†jsã€cssç­‰é™æ€èµ„æº
  extractSourceDom(htmlDom, app)

  // è·å–micro-app-headå…ƒç´ 
  const microAppHead = htmlDom.querySelector('micro-app-head')
  // å¦‚æœæœ‰è¿œç¨‹cssèµ„æºï¼Œåˆ™é€šè¿‡fetchè¯·æ±‚
  if (app.source.links.size) {
    fetchLinksFromHtml(app, microAppHead, htmlDom)
  } else {
    app.onLoad(htmlDom)
  }

  // å¦‚æœæœ‰è¿œç¨‹jsèµ„æºï¼Œåˆ™é€šè¿‡fetchè¯·æ±‚
  if (app.source.scripts.size) {
    fetchScriptsFromHtml(app, htmlDom)
  } else {
    app.onLoad(htmlDom)
  }
}
```
`fetchLinksFromHtml`å’Œ`fetchScriptsFromHtml`åˆ†åˆ«è¯·æ±‚csså’Œjsèµ„æºï¼Œè¯·æ±‚èµ„æºåçš„å¤„ç†æ–¹å¼ä¸åŒï¼Œcssèµ„æºä¼šè½¬åŒ–ä¸ºstyleæ ‡ç­¾æ’å…¥DOMä¸­ï¼Œè€Œjsä¸ä¼šç«‹å³æ‰§è¡Œï¼Œæˆ‘ä»¬ä¼šåœ¨åº”ç”¨çš„mountæ–¹æ³•ä¸­æ‰§è¡Œjsã€‚

ä¸¤ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°æ–¹å¼å¦‚ä¸‹ï¼š
```js
// src/source.js
/**
 * è·å–linkè¿œç¨‹èµ„æº
 * @param app åº”ç”¨å®ä¾‹
 * @param microAppHead micro-app-head
 * @param htmlDom html DOMç»“æ„
 */
 export function fetchLinksFromHtml (app, microAppHead, htmlDom) {
  const linkEntries = Array.from(app.source.links.entries())
  // é€šè¿‡fetchè¯·æ±‚æ‰€æœ‰cssèµ„æº
  const fetchLinkPromise = []
  for (const [url] of linkEntries) {
    fetchLinkPromise.push(fetchSource(url))
  }

  Promise.all(fetchLinkPromise).then((res) => {
    for (let i = 0; i < res.length; i++) {
      const code = res[i]
      // æ‹¿åˆ°cssèµ„æºåæ”¾å…¥styleå…ƒç´ å¹¶æ’å…¥åˆ°micro-app-headä¸­
      const link2Style = document.createElement('style')
      link2Style.textContent = code
      microAppHead.appendChild(link2Style)

      // å°†ä»£ç æ”¾å…¥ç¼“å­˜ï¼Œå†æ¬¡æ¸²æŸ“æ—¶å¯ä»¥ä»ç¼“å­˜ä¸­è·å–
      linkEntries[i][1].code = code
    }

    // å¤„ç†å®Œæˆåæ‰§è¡ŒonLoadæ–¹æ³•
    app.onLoad(htmlDom)
  }).catch((e) => {
    console.error('åŠ è½½csså‡ºé”™', e)
  })
}

/**
 * è·å–jsè¿œç¨‹èµ„æº
 * @param app åº”ç”¨å®ä¾‹
 * @param htmlDom html DOMç»“æ„
 */
 export function fetchScriptsFromHtml (app, htmlDom) {
  const scriptEntries = Array.from(app.source.scripts.entries())
  // é€šè¿‡fetchè¯·æ±‚æ‰€æœ‰jsèµ„æº
  const fetchScriptPromise = []
  for (const [url, info] of scriptEntries) {
    // å¦‚æœæ˜¯å†…è”scriptï¼Œåˆ™ä¸éœ€è¦è¯·æ±‚èµ„æº
    fetchScriptPromise.push(info.code ? Promise.resolve(info.code) :  fetchSource(url))
  }

  Promise.all(fetchScriptPromise).then((res) => {
    for (let i = 0; i < res.length; i++) {
      const code = res[i]
      // å°†ä»£ç æ”¾å…¥ç¼“å­˜ï¼Œå†æ¬¡æ¸²æŸ“æ—¶å¯ä»¥ä»ç¼“å­˜ä¸­è·å–
      scriptEntries[i][1].code = code
    }

    // å¤„ç†å®Œæˆåæ‰§è¡ŒonLoadæ–¹æ³•
    app.onLoad(htmlDom)
  }).catch((e) => {
    console.error('åŠ è½½jså‡ºé”™', e)
  })
}
```

ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œcsså’ŒjsåŠ è½½å®Œæˆåéƒ½æ‰§è¡Œäº†`onLoad`æ–¹æ³•ï¼Œæ‰€ä»¥`onLoad`æ–¹æ³•è¢«æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å®Œå–„`onLoad`æ–¹æ³•å¹¶æ¸²æŸ“å¾®åº”ç”¨ã€‚

### æ¸²æŸ“
å› ä¸º`onLoad`è¢«æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿›è¡Œæ ‡è®°ï¼Œå½“ç¬¬äºŒæ¬¡æ‰§è¡Œæ—¶è¯´æ˜æ‰€æœ‰èµ„æºéƒ½åŠ è½½å®Œæˆï¼Œç„¶åè¿›è¡Œæ¸²æŸ“æ“ä½œã€‚
```js
// /src/app.js

// åˆ›å»ºå¾®åº”ç”¨
export default class CreateApp {
  ...
  // èµ„æºåŠ è½½å®Œæ—¶æ‰§è¡Œ
  onLoad (htmlDom) {
    this.loadCount = this.loadCount ? this.loadCount + 1 : 1
    // ç¬¬äºŒæ¬¡æ‰§è¡Œä¸”ç»„ä»¶æœªå¸è½½æ—¶æ‰§è¡Œæ¸²æŸ“
    if (this.loadCount === 2 && this.status !== 'unmount') {
      // è®°å½•DOMç»“æ„ç”¨äºåç»­æ“ä½œ
      this.source.html = htmlDom
      // æ‰§è¡Œmountæ–¹æ³•
      this.mount()
    }
  }
  ...
}
```

åœ¨`mount`æ–¹æ³•ä¸­å°†DOMç»“æ„æ’å…¥æ–‡æ¡£ä¸­ï¼Œç„¶åæ‰§è¡Œjsæ–‡ä»¶è¿›è¡Œæ¸²æŸ“æ“ä½œï¼Œæ­¤æ—¶å¾®åº”ç”¨å³å¯å®ŒæˆåŸºæœ¬çš„æ¸²æŸ“ã€‚

```js
// /src/app.js

// åˆ›å»ºå¾®åº”ç”¨
export default class CreateApp {
  ...
  /**
   * èµ„æºåŠ è½½å®Œæˆåè¿›è¡Œæ¸²æŸ“
   */
  mount () {
    // å…‹éš†DOMèŠ‚ç‚¹
    const cloneHtml = this.source.html.cloneNode(true)
    // åˆ›å»ºä¸€ä¸ªfragmentèŠ‚ç‚¹ä½œä¸ºæ¨¡ç‰ˆï¼Œè¿™æ ·ä¸ä¼šäº§ç”Ÿå†—ä½™çš„å…ƒç´ 
    const fragment = document.createDocumentFragment()
    Array.from(cloneHtml.childNodes).forEach((node) => {
      fragment.appendChild(node)
    })

    // å°†æ ¼å¼åŒ–åçš„DOMç»“æ„æ’å…¥åˆ°å®¹å™¨ä¸­
    this.container.appendChild(fragment)

    // æ‰§è¡Œjs
    this.source.scripts.forEach((info) => {
      (0, eval)(info.code)
    })

    // æ ‡è®°åº”ç”¨ä¸ºå·²æ¸²æŸ“
    this.status = 'mounted'
  }
  ...
}
```

ä»¥ä¸Šæ­¥éª¤å®Œæˆäº†å¾®å‰ç«¯çš„åŸºæœ¬æ¸²æŸ“æ“ä½œï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ•ˆæœã€‚

### å¼€å§‹ä½¿ç”¨
æˆ‘ä»¬åœ¨åŸºåº§åº”ç”¨ä¸‹é¢åµŒå…¥å¾®å‰ç«¯ï¼š
```html
<!-- vue2/src/pages/page1.vue -->
<template>
  <div>
    <img alt="Vue logo" src="../assets/logo.png">
    <HelloWorld :msg="'åŸºåº§åº”ç”¨vue@' + version" />
    <!-- ğŸ‘‡åµŒå…¥å¾®å‰ç«¯ -->
    <micro-app name='app' url='http://localhost:3001/'></micro-app>
  </div>
</template>
```

æœ€ç»ˆå¾—åˆ°çš„æ•ˆæœå¦‚ä¸‹ï¼š
![](https://img13.360buyimg.com/imagetools/jfs/t1/185669/20/17155/175504/6107c08dEa8fb8327/0aaed694618d387e.png)

å¯è§react17å·²ç»æ­£å¸¸åµŒå…¥è¿è¡Œäº†ã€‚

æˆ‘ä»¬ç»™å­åº”ç”¨react17æ·»åŠ ä¸€ä¸ªæ‡’åŠ è½½é¡µé¢`page2`ï¼ŒéªŒè¯ä¸€ä¸‹å¤šé¡µé¢åº”ç”¨æ˜¯å¦å¯ä»¥æ­£å¸¸è¿è¡Œã€‚

![](https://img12.360buyimg.com/imagetools/jfs/t1/182096/10/17439/269998/6107c866E0db7a485/f3ccdbfa15178fe9.png)

`page2`çš„å†…å®¹ä¹Ÿéå¸¸ç®€å•ï¼Œåªæ˜¯ä¸€æ®µæ ‡é¢˜ï¼š
![](https://img14.360buyimg.com/imagetools/jfs/t1/182410/34/17370/31568/6107c8b0E5eacf97e/a1669c5dd48946f7.png)

åœ¨é¡µé¢ä¸Šæ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»å³å¯è·³è½¬page2ã€‚
![](https://img10.360buyimg.com/imagetools/jfs/t1/185081/15/17251/111042/6107c97dE0a545e05/4df4b4ac364d4cdf.png)

ç‚¹å‡»æŒ‰é’®ï¼Œå¾—åˆ°çš„æ•ˆæœå¦‚ä¸‹ï¼š
![](https://img10.360buyimg.com/imagetools/jfs/t1/194701/15/15808/110041/6107c9e5E64b542ea/05047937cf87a814.png)

æ­£å¸¸æ¸²æŸ“ï¼ğŸ‰ğŸ‰

ä¸€ä¸ªç®€æ˜“çš„å¾®å‰ç«¯æ¡†æ¶å°±å®Œæˆäº†ï¼Œå½“ç„¶æ­¤æ—¶å®ƒæ˜¯éå¸¸åŸºç¡€çš„ï¼Œæ²¡æœ‰JSæ²™ç®±å’Œæ ·å¼éš”ç¦»ã€‚

å…³äºJSæ²™ç®±å’Œæ ·å¼éš”ç¦»æˆ‘ä»¬ä¼šå•ç‹¬åšä¸€ç¯‡æ–‡ç« åˆ†äº«ï¼Œä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬è¿˜æœ‰ä¸€ä»¶äº‹æƒ…éœ€è¦åš - å¸è½½åº”ç”¨ã€‚

### å¸è½½
å½“micro-appå…ƒç´ è¢«åˆ é™¤æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œç”Ÿå‘½å‘¨æœŸå‡½æ•°`disconnectedCallback`ï¼Œæˆ‘ä»¬åœ¨æ­¤å¤„æ‰§è¡Œå¸è½½ç›¸å…³æ“ä½œã€‚

```js
// /src/element.js

class MyElement extends HTMLElement {
  ...
  disconnectedCallback () {
    // è·å–åº”ç”¨å®ä¾‹
    const app = appInstanceMap.get(this.name)
    // å¦‚æœæœ‰å±æ€§destoryï¼Œåˆ™å®Œå…¨å¸è½½åº”ç”¨åŒ…æ‹¬ç¼“å­˜çš„æ–‡ä»¶
    app.unmount(this.hasAttribute('destory'))
  }
}
```

æ¥ä¸‹æ¥å®Œå–„åº”ç”¨çš„`unmount`æ–¹æ³•ï¼š
```js
// /src/app.js

export default class CreateApp {
  ...
  /**
   * å¸è½½åº”ç”¨
   * @param destory æ˜¯å¦å®Œå…¨é”€æ¯ï¼Œåˆ é™¤ç¼“å­˜èµ„æº
   */
  unmount (destory) {
    // æ›´æ–°çŠ¶æ€
    this.status = 'unmount'
    // æ¸…ç©ºå®¹å™¨
    this.container = null
    // destoryä¸ºtrueï¼Œåˆ™åˆ é™¤åº”ç”¨
    if (destory) {
      appInstanceMap.delete(this.name)
    }
  }
}
```

å½“destoryä¸ºtrueæ—¶ï¼Œåˆ é™¤åº”ç”¨çš„å®ä¾‹ï¼Œæ­¤æ—¶æ‰€æœ‰é™æ€èµ„æºå¤±å»äº†å¼•ç”¨ï¼Œè‡ªåŠ¨è¢«æµè§ˆå™¨å›æ”¶ã€‚

åœ¨åŸºåº§åº”ç”¨vue2ä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œåˆ‡æ¢å­åº”ç”¨çš„æ˜¾ç¤º/éšè—çŠ¶æ€ï¼ŒéªŒè¯å¤šæ¬¡æ¸²æŸ“å’Œå¸è½½æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚

æ•ˆæœå¦‚ä¸‹ï¼š
![](https://cangdu.org/img/simple-micro-app-1-1.gif)

ä¸€ä¸”è¿è¡Œæ­£å¸¸ï¼ğŸ‰

## ç»“è¯­
åˆ°æ­¤å¾®å‰ç«¯æ¸²æŸ“ç¯‡çš„æ–‡ç« å°±ç»“æŸäº†ï¼Œæˆ‘ä»¬å®Œæˆäº†å¾®å‰ç«¯çš„æ¸²æŸ“å’Œå¸è½½åŠŸèƒ½ï¼Œå½“ç„¶å®ƒçš„åŠŸèƒ½æ˜¯éå¸¸ç®€å•çš„ï¼Œåªæ˜¯å™è¿°äº†å¾®å‰ç«¯çš„åŸºæœ¬å®ç°æ€è·¯ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå®ŒæˆJSæ²™ç®±ã€æ ·å¼éš”ç¦»ã€æ•°æ®é€šè®¯ç­‰åŠŸèƒ½ï¼Œå¦‚æœä½ èƒ½è€ä¸‹å¿ƒæ¥è¯»ä¸€éï¼Œä¼šå¯¹ä½ äº†è§£å¾®å‰ç«¯æœ‰å¾ˆå¤§å¸®åŠ©ã€‚

## ä»£ç åœ°å€ï¼š
https://github.com/bailicangdu/simple-micro-app
